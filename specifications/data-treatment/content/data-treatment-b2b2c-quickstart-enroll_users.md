---
layout: doc-article
permalink: /specifications/data-treatment/quickstart/b2b2c/enroll-end-users/
section: specifications
subsection: data-treatment
categorie: Quickstart
title: Enroll End-Users
description: "End Users should give access to their data (enrollment)if they want to use a developer app."
redirect_from: 
    - /webapi/b2c/quickstart/
require: api-reference
---

<div class="notification notification-empty-bg">
{% capture short %}
**Requirement**:
  - üë§ A [registered Application]({{site.baseurl}}/specifications/data-treatment/quickstart/b2b2c/app-registration/#article) in Stellantis systems and [its credentials]({{site.baseurl}}/specifications/data-treatment/quickstart/b2b2c/app-registration/#2%EF%B8%8F‚É£-generates-encryption-keys--csr).
  - üîë Your Application [private key]({{site.baseurl}}/specifications/data-treatment/quickstart/b2b2c/app-registration/#2%EF%B8%8F‚É£-generates-encryption-keys--csr).

**Tutorial Output**:
  - ü™ô An Access Token allowing requesting data about a user enrolled in your App.
{% endcapture %}
{{ short | markdownify}}
</div>

This tutorial explains how to enroll an End User in order to obtain an **Access Token** using the **OAuth2** Authorization Code Flow. This token allows **requesting data** about the user.

First, we will need to verify if the [vehicle is eligible](#1Ô∏è‚É£-vehicle-capabilities) for your use case. Then, we will see how to implement the **OAuth2 Authorization Code Flow** by creating the  [consent request](#2Ô∏è‚É£-request-consent) in your App and finally, to exchange the Authorization Code against the [access token](#3Ô∏è‚É£-access-token).

{% include realms.md %}

## 1Ô∏è‚É£ Vehicle Capabilities

First of all, before enrolling an end user, you must make sure that the targeted vehicle is eligible to your application use case.

Indeed, as explained in [Data Availability & Scopes]({{site.baseurl}}/specifications/data-treatment/quickstart/b2b2c/data-availability-scopes/#article), all vehicles are not able to generate all the data listed in [API Reference]({{site.baseurl}}/webapi/b2c/api-reference/references/#article). When data is not generated by a vehicle, the field or object is not outputted in the API response.

That's why you need to verify that a vehicle is able to provide the data required for your application use case. It can be done using the **capability API**.

<img src="{{site.baseurl}}/assets/images/b2c-vhcl-capabilities.png" alt="b2c-vhcl-capabilities" style="width: 550px">

The capability API will return the **technical capabilities** of the vehicles in terms of datasets. These capability datasets are subsets of [vehicles scopes]({{site.baseurl}}/specifications/data-treatment/quickstart/b2b2c/data-availability-scopes/#list-of-scopes). Relations between APIs endpoints, data & scopes can be found in the [Data Catalog]({{site.baseurl}}/connected-vehicles/data-catalog/#article) (each data has a *"Scopes"* section) and the [API Reference]({{site.baseurl}}/webapi/b2c/api-reference/references/#article) (APIs endpoints have an *"authorization>scope"* dropdown).

Using the response of the capability API, and knowing the required data for your use case, you can determine whether the vehicle is **eligible to your service or not**. If the vehicle is not eligible, you must not enroll the user under this use case, but you can find a fallback use case fitting the vehicle capabilities.

For example if your use case requires the vehicle location, but the scope `data:position` is not returned in the capability API response for this vehicle, then you should probably not offer your service to this user.

> **Technical capability & Vehicle eligibility:** a data being available within the capability API doesn't mean that the user is able to subscribe third party services, checkout [vehicle services]({{site.baseurl}}/specifications/data-treatment/quickstart/b2b2c/data-availability-scopes/#-vehicle-data-upload).


#### Capability API Example

Type|Name|Value|Description|Required
-|-|-|-|-
Path Parameter|`{vin}`|`{vin}`| Vehicle VIN to check. | Yes
Query Parameter|`client_id`|`<client_id>`| *Client Id* of your application.|Yes
Query Parameter|`extension`|`onboardCapabilities`| Filters only capability data of this API. | No
Header|`x-introspect-realm`|`<realm>`| Vehicle manufacturer [realm](#manufacturers-brands--realms). | Yes
File|Client Certificate|`path/to/client_certificate.pem`| Your SSL certificate for authentication in Stelantis network.|Yes
File|Private Key|`path/to/key.pem`| Your Private Key file.| Yes

{% capture getEligibilityRequest %}
```shell
$ curl
  --location 'https://apim.datachain.iov.staging.vhl-iov.private/v1/accounts/vehicles/VR3ZZCLOE07021000/capability' \
  --header 'X-Introspect-Realm: B2C' \
  --header 'X-CVS-Scope: data:vehicle VIN:VR7ZZCLOE08111000' \
  --header 'X-IBM-Client-Id: bc44396bed3a0c0ed403479db1d46895' \
  --header 'X-CVS-User-Id: AP-ACNT200000941890' \
  --header 'X-IBM-Client-Secret: f2e4573260154732de1d50c793eaafe1' \
  --header 'X-Token: 3af98c7b-4e2d-9f1a-0bc5-d82e6f19a2fc'
```
{% endcapture %}

{% capture getEligibilityResponse %}
```http
HTTP/1.1 200 OK
Date: Day, XX Mon YYYY HH:MM:SS GMT
Content-Type: application/json

{
  "vin": "VR3ZZCLOE07021000",
  "brand": "83",
  "model": "A5U",
  "motorization": "Thermic",
  "onboardCapabilities": {
    "data": [
      "data:telemetry:vehicle:preconditioning",
      "data:telemetry:vehicle:doorsState",
      "data:telemetry:vehicle:ignition",
      "data:telemetry:vehicle:maintenance",
      "data:telemetry:vehicle:drivingBehaviour",
      "data:telemetry:vehicle:odometer",
      "data:alert",
      "data:telemetry:vehicle:transmission",
      "data:telemetry:vehicle:engines",
      "data:telemetry:vehicle:battery",
      "data:telemetry:vehicle:lightingSystem",
      "data:telemetry:vehicle",
      "data:telemetry:vehicle:energies",
      "data:collision",
      "data:telemetry:vehicle:kinetic",
      "data:telemetry:privacy",
      "data:telemetry:vehicle:adas",
      "data:trip",
      "data:telemetry",
      "data:telemetry:vehicle:environment",
      "data:telemetry:vehicle:safety",
      "data:position"
    ],
    "remote": {
      "preconditioning": {
        "supported": true,
        "scopeName": [
          "remote:preconditioning:write"
        ],
        "parameters": {
          "program": {
            "size": 4,
            "temperature": true
          },
          "immediate": false,
          "settings": true
        }
      },
      "charging": {
        "supported": true,
        "scopeName": [
          "remote:charging:write"
        ],
        "parameters": {
          "programs": {
            "supported": true,
            "size": 2,
            "occurrence": true,
            "minChargingLevel": true,
            "maxChargingLevel": true,
            "enabled": true
          }
        }
      },
      "door": {
        "supported": true,
        "scopeName": [
          "remote:door:write"
        ]
      },
      "horn": {
        "supported": true,
        "scopeName": [
          "remote:horn:write"
        ]
      },
      "lights": {
        "supported": true,
        "scopeName": [
          "remote:lights:write"
        ]
      },
      "wakeup": {
        "supported": false,
        "scopeName": [
          "remote:wakeup:write"
        ]
      },
      "navigation": {
        "supported": false,
        "scopeName": [
          "remote:navigation:write"
        ]
      },
      "stolen": {
        "supported": false
      },
      "vehicleFinder": {
        "supported": false,
        "scopeName": [
          "remote:vehicleFinder:write"
        ]
      },
      "onBoardPersonalData": {
        "supported": false,
        "scopeName": [
          "remote:onboardPersonalData:write"
        ]
      },
      "tanSuppress": {
        "supported": false
      },
      "pnc": {
        "supported": false,
        "scopeName": [
          "remote:pnc:contractInfo:write"
        ]
      }
    }
  }
}
```

{% endcapture %}


{% include webapi-curl.md 
  apiEndpointB2C='/accounts/vehicles/{vin}/capability'
  apiBaseUrl='https://apim.datachain.iov.staging.vhl-iov.private/v1'
  httpVerb='GET'
  200=getEligibilityResponse
%}


## 2Ô∏è‚É£ Request Consent

<img src="{{site.baseurl}}/assets/images/b2c-enroll-users.svg" alt="b2c-enroll-users" style="width:400px">

## 2Ô∏è‚É£‚Ä¢1Ô∏è‚É£ Authorization Request

In order to enroll an End User, you have to trigger the following HTTP authorization request from your App in the End User device. This process is called **OAuth2 Authorization Code Flow** and is widely defined in [RFC 6749](https://datatracker.ietf.org/doc/html/rfc6749).

This will prompt an external user agent (web view) where the End User will be able to log in and authorize access to its Stellantis account. The following parameters are required:

> **Scopes**: scopes are sets of data that a Ressource Owner can share to a third-party application through this authorization process. List of scope is [available here]({{site.baseurl}}/specifications/data-treatment/quickstart/b2b2c/data-availability-scopes/#list-of-scopes). You can also browse individual data and their scopes in the [Data Catalog]({{site.baseurl}}/connected-vehicles/data-catalog/#article).

Type|Name|Value|Description|Required
-|-|-|-|-
Path Parameter|`{brand.tld}`|`{brand.tld}`| Vehicle manufacturer [brand.tld](#manufacturers-brands--realms). | Yes
Query Parameter|`client_id`|`<client_id>`| [Client id]({{site.baseurl}}/specifications/data-treatment/quickstart/b2b2c/app-registration/#article) of your application.|Yes
Query Parameter|`response_type`|`code`| Use OAuth2 Authorization code flow. | Yes
Query Parameter|`scope`|`<scope1>,<scope2>,etc.`| The list of scopes requested to your customer (Ressource Owner). | Yes
Query Parameter|`redirect_uri`|`<redirect_uri>`| The URI address to redirect the user at the end of the authorization process. | Yes
Query Parameter|`state`|`<state>`| A state value generated on your side, it will be returned along with the [Authorization Code](#2Ô∏è‚É£‚Ä¢4Ô∏è‚É£-authorization-code) in the redirection. Recommended, checking this parameter when it's returned allows tracking and identifying the request, and prevent attacks. | No
Query Parameter|`local`|`<local>`|  End user browser language (by default, en-GB). Possible values: *ar-EG,cs-CZ,da-DK,de-AT,de-CH,de-DE,en-AU,en-EG,en-GB,en-IE,en-JP,en-MT,en-NZ,en-ZA,es-AR,es-CL,es-ES,es-MX,et-EE,fi-FI,fr-BE,fr-CH,fr-DZ,fr-FR,fr-LU,fr-MA,fr-MQ,fr-RE,fr-TN,hr-HR,hu-HU,it-CH,it-IT,nb-NO,nl-BE,nl-NL,pl-PL,pt-BR,pt-PT,ru-RU,ru-UA,sk-SK,sl-SI,sv-SE,tr-TR,uk-UA,ar-DZ,ar-MA,ar-PS,el-GR,es-CO,es-PE,fa-IR,fr-GF,fr-GP,fr-MG,he-IL,ja-JP,ko-KR,en-PS,ar-SA,en-SA,ar-AE,en-AE,en-SG,es-UY,en-MY,en-BN,ro-RO,mk-MK,es-EC,en-ES,fr-LB,en-LB,bg-BG,sr-RS,en-CY,fr-NC,es-CR,es-PY,is-IS,en-IS,fr-SN,en-IN,en-JO,en-MU,lv-LV,lt-LT,zh-TW*. | No

{% capture getAuthRequest %}
```shell
$ curl \
--location 'https://idfed-preprod.mpsa.com:9033/as/token.oauth2' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--header 'Cookie: PF=1rqfTtNRP8Rrjy45dO49r0' \
--data-urlencode 'grant_type=client_credentials' \
--data-urlencode 'scope=prd:CLV' \
--data-urlencode 'client_id=CCOFOZSBAAGXISEHNGDUMCGSHVVDXQLT'  
```
{% endcapture %}


{% include webapi-curl.md 
  apiEndpointB2C='/authorize'
  apiBaseUrl=site.cvsOAuth2
  httpVerb='GET'
  requestQuery=getAuthRequest
  no_link=true
%}


## 2Ô∏è‚É£‚Ä¢2Ô∏è‚É£ Prompt Triggering

Before the Authorization prompt is triggered, Stellantis performs the following checks on the request:
- The **App should be registered** and the <client_id> should exists.
- The requested **scopes should match** the one declared in the [App Registration]({{site.baseurl}}/specifications/data-treatment/quickstart/b2b2c/app-registration/#article). 

In cases these checks are performed successfully, the redirection prompt is sent to the End User device triggering an **external user agent** (web view) on the End User device.

## 2Ô∏è‚É£‚Ä¢3Ô∏è‚É£ User Inputs

When the external user agent authorization prompt is triggered by the End User device, you have no more access to the authorization process. 

In the prompted external user agent (web view), the user will follow the **consent process** to give access to its Stellantis Account.

The journey of the End User in the prompted external user agent is detailed in the [User Journey section]({{site.baseurl}}/specifications/data-treatment/quickstart/b2b2c/end-user-journey/#article).

**User Journey**: if not previously performed for another Stellantis Connected service, the following steps are required on the End User side before being able to authorize access to its Stellantis Account:
- **Create an account** in Stellantis system.
- **Link a vehicle** to the account.
- **Enable connectivity** for partners (accessing party).

> **Closing the App:** If the user needs to leave your application during the previous process, the authorization request might fail. In this case, the user needs to **restart** the authorization process from the start.


## 2Ô∏è‚É£‚Ä¢4Ô∏è‚É£ Authorization Code

In the **OAuth2 Authorization Code Flow**, after the Resource Owner consent to share access to its data, an automatic redirection is triggered to the Accessing Party URI. This restriction includes an **Authorization Code** as an URI parameter. This Authorization Code can be exchanged against an **Access Token**.

If the account is **set up properly** (check out [step 2.3](#2Ô∏è‚É£3Ô∏è‚É£-user-inputs)), and the End-User **authorizes your App** to access the requested scopes, the redirection URI contains the **Authorization Code**.

The redirect URI will contain the following data as parameters:
- The list of **scopes authorized** by the user
- **State** value generated on your side from the initial request, for your own use.
- The **authorization code**, this code should be exchanged for an access token.

>**State:** This state is for your own use. In order to mitigate **CSRF** attacks, you should make sure that the state value received in 2.3 is a state value that you have generated in step 2.1.
<br>This state being generated on your side, you can also use it to **embed data** in step 2.1 for future use in step 2.3. Doing so, it's possible to **track the request** and to notify your user if a consent request has been initialized but not completed.

{% capture getAuthResponse %}
```http
HTTP/1.1 302 Found
Date: Day, XX Mon YYYY HH:MM:SS GMT
Location: http://<app_callback_uri>
          ?scope=ConnectivityForPartners,Remote
          &state=<state>
          &code=<code>
```
{% endcapture %}


{% include webapi-curl.md
  apiEndpointB2C='/authorize'
  apiBaseUrl=site.cvsOAuth2
  httpVerb='GET'
  hideRequest=true
  200=getAuthResponse
  no_link=true
%}

## 3Ô∏è‚É£ Access Token

<img src="{{site.baseurl}}/assets/images/b2c-request-access-token.svg" alt="b2c-request-access-token" style="width:525px">

The **Authentication Code** obtained in [step 2](#2Ô∏è‚É£-request-consent) should be exchanged against an **Access Token**.

> **Client Secret:** Exchanging the authentication code for an Access Token must be done from **your own server** and not from the Ressource Owner device. Furthermore the API used for this purpose requires your Application Client Secret and this data must remain confidential.

This API allows requesting access token, it requires the following parameters:

Type|Name|Value|Description|Required
-|-|-|-|-
Path Parameter|`{brand.tld}`|`{brand.tld}`| Vehicle manufacturer [brand.tld](#manufacturers-brands--realms). | Yes
Header|`authorization: Basic`|`<base64(<client_id>:<client_secret>)>`| Your App [Client Id and Secret]({{site.baseurl}}/specifications/data-treatment/quickstart/b2b2c/app-registration/#article) encoded in base64. |Yes
Header|`content-type`|`<application/x-www-form-urlencoded>`| Content type. |Yes
Data |`grant_type`|`authorization_code`| Use OAuth2 Authorization code flow. | Yes
Data |`redirect_uri`|`<redirect_uri>`| The URI redirection address. It must be the same as in step 2.1.| Yes
Data |`code`|`<code>`| The authorization code received in step 2.4. | Yes

{% capture postAccessTokenRequest %}
```shell
$ curl \
  --request POST \
  --url '{{site.cvsOAuth2}}/access_token' \
  --header 'authorization: Basic <base64(<client_id>:<client_secret>)>'\
  --header 'content-type: application/x-www-form-urlencoded' \
  --data 'grant_type=authorization_code' \
  --data 'redirect_uri=<app_callback_uri>' \
  --data 'code=<code>' \
```
{% endcapture %}

{% capture postAccessTokenResponse %}
```http
HTTP/1.1 200 OK
Date: Day, XX Mon YYYY HH:MM:SS GMT

{
  "scope": "openid profile",
  "expires_in": <time>,
  "token_type": "Bearer",
  "refresh_token": <refresh_token>,
  "id_token": <id_token>,
  "access_token": <access_token>
}
```
{% endcapture %}

{% include webapi-curl.md 
  apiEndpointB2C='/access_token'
  httpVerb='POST'
  apiBaseUrl=site.cvsOAuth2
  requestQuery=postAccessTokenRequest
  200=postAccessTokenResponse
  no_link=true
%}


## Renew Token

In case the access token expires, you should renew the set of tokens using the following API call from your server. 

This request requires that you still have access to the refresh token of [step 3](#3Ô∏è‚É£-access-token).

Type|Name|Value|Description|Required
-|-|-|-|-
Path Parameter|`{brand.tld}`|`{brand.tld}`| Vehicle manufacturer [brand.tld](#manufacturers-brands--realms). | Yes
Query Parameter | `realm`| `<realm>` | Vehicle manufacturer [realm](#manufacturers-brands--realms). | Yes 
Header|`authorization: Basic`|`<base64(<client_id>:<client_secret>)>`| Your App [Client id and secret]({{site.baseurl}}/specifications/data-treatment/quickstart/b2b2c/app-registration/#article) encoded in base64. |Yes
Header|`content-type`|`<application/x-www-form-urlencoded>`| Content type. |Yes
Data |`grant_type`|`refresh_token`| Token renewal. | Yes
Data |`refresh_token`|`<refresh_token>`| Refresh token received in step 3. | Yes

{% capture postRenewAccessTokenRequest %}
```shell
$ curl \
  --request POST \
  --url '{{site.cvsOAuth2}}/access_token' \
  --data-urlencode 'realm=<realm>'
  --header 'authorization: Basic <base64(<client_id>:<client_secret>)>'\
  --header 'content-type: application/x-www-form-urlencoded' \
  --data 'grant_type=refresh_token' \
  --data 'refresh_token=<refresh_token>' \
```
{% endcapture %}

{% capture postRenewAccessTokenResponse %}
```http
HTTP/1.1 200 OK
Date: Day, XX Mon YYYY HH:MM:SS GMT

{
    "scope": "openid profile",
    "expires_in": <time>,
    "token_type": "Bearer",
    "refresh_token": <refresh_token>,
    "id_token": <id_token>,
    "access_token": <access_token>
}
```
{% endcapture %}

{% include webapi-curl.md 
  apiEndpointB2C='/access_token'
  apiBaseUrl=site.cvsOAuth2
  httpVerb='POST'
  requestQuery=postRenewAccessTokenRequest
  200=postRenewAccessTokenResponse
  no_link=true
%}

## Revoke Token (Logout User)

Type|Name|Value|Description|Required
-|-|-|-|-
Path Parameter|`{brand.tld}`|`{brand.tld}`| Vehicle manufacturer [brand.tld](#manufacturers-brands--realms). | Yes
Query Parameter | `realm`| `<realm>` | Vehicle manufacturer [realm](#manufacturers-brands--realms). | Yes 
Header|`authorization: Basic`|`<base64(<client_id>:<client_secret>)>`| Your App [Client id and secret]({{site.baseurl}}/specifications/data-treatment/quickstart/b2b2c/app-registration/#article) encoded in base64. |Yes
Header|`content-type`|`<application/x-www-form-urlencoded>`| Content type. |Yes
Data |`token`|`<refresh_toke OR access_token>`| Access or refresh token. | Yes

You should implement a feature in your application if the End User wants to log out.

This action should lead to the revocation of the token:


{% capture postRevokeTokenRequest %}
```shell
$ curl \
  --request POST \
  --url '{{site.cvsOAuth2}}/token/revoke' \
  --data-urlencode 'realm=<realm>' \
  --header 'authorization: Basic <base64(<client_id>:<client_secret>)>'\
  --header 'content-type: application/x-www-form-urlencoded' \
  --data 'refresh_token=<refresh_toke OR access_token>' \
```
{% endcapture %}

{% capture postRevokeTokenResponse %}
```http
HTTP/1.1 200 OK
Date: Day, XX Mon YYYY HH:MM:SS GMT
```
{% endcapture %}

{% include webapi-curl.md 
  apiEndpointB2C='/token/revoke'
  apiBaseUrl=site.cvsOAuth2
  httpVerb='POST'
  requestQuery=postRevokeTokenRequest
  200=postRevokeTokenResponse
  no_link=true
%}

> **Note:** depending on your needs, it's possible to revoke the **access token** or the **renew token**. Revoking a refresh token implies the revocation of all associated access token.

#### Access User Data

Once you have an Access Token, you can [build the HTTP request]({{site.baseurl}}/specifications/data-treatment/quickstart/b2b2c/access-end-user-data/#article) to access this user data.